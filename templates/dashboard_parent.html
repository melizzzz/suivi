{% extends "base.html" %}

{% block title %}Tableau de Bord Parent{% endblock %}

{% block content %}
<h2>Tableau de Bord Parent</h2>
<p class="text-muted">Voici le suivi de vos enfants</p>

<div class="row">
    {% if enfants %}
        {% for enfant in enfants %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5>{{ enfant.prenom }} {{ enfant.nom }}</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h6>Sessions</h6>
                            <h4 class="text-primary">{{ enfant.sessions|length }}</h4>
                        </div>
                        <div class="col-4">
                            <h6>À payer</h6>
                            {% set total_a_payer = enfant.sessions|selectattr('payee', 'equalto', False)|map(attribute='prix')|sum %}
                            <h4 class="text-warning">{{ "%.2f"|format(total_a_payer) }}€</h4>
                        </div>
                        <div class="col-4">
                            <h6>Payé</h6>
                            {% set total_paye = enfant.sessions|selectattr('payee', 'equalto', True)|map(attribute='prix')|sum %}
                            <h4 class="text-success">{{ "%.2f"|format(total_paye) }}€</h4>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6>Dernières sessions :</h6>
                    {% set dernieres_sessions = enfant.sessions|sort(attribute='date_session', reverse=true)|list %}
                    {% if dernieres_sessions %}
                        <div class="list-group list-group-flush">
                            {% for session in dernieres_sessions[:3] %}
                            <div class="list-group-item d-flex justify-content-between align-items-center p-2">
                                <div>
                                    <strong>{{ session.matiere }}</strong><br>
                                    <small class="text-muted">{{ session.date_session.strftime('%d/%m/%Y à %H:%M') }}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-{{ 'success' if session.payee else 'warning' }}">
                                        {{ "%.2f"|format(session.prix) }}€
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted small">Aucune session enregistrée</p>
                    {% endif %}
                    
                    <div class="mt-3">
                        <a href="{{ url_for('view_student', student_id=enfant.id) }}" class="btn btn-primary btn-sm w-100">
                            Voir tous les détails
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="alert alert-info">
                <h5>Aucun enfant enregistré</h5>
                <p>Il semble qu'aucun enfant ne soit associé à votre compte. Contactez le professeur pour qu'il ajoute votre enfant.</p>
            </div>
        </div>
    {% endif %}
</div>

{% if enfants %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Résumé financier</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    {% set total_global_a_payer = enfants|map(attribute='sessions')|sum(start=[])|selectattr('payee', 'equalto', False)|map(attribute='prix')|sum %}
                    {% set total_global_paye = enfants|map(attribute='sessions')|sum(start=[])|selectattr('payee', 'equalto', True)|map(attribute='prix')|sum %}
                    {% set total_sessions = enfants|map(attribute='sessions')|sum(start=[])|list|length %}
                    
                    <div class="col-md-3">
                        <h6>Total Sessions</h6>
                        <h3 class="text-info">{{ total_sessions }}</h3>
                    </div>
                    <div class="col-md-3">
                        <h6>Total à Payer</h6>
                        <h3 class="text-warning">{{ "%.2f"|format(total_global_a_payer) }}€</h3>
                    </div>
                    <div class="col-md-3">
                        <h6>Total Payé</h6>
                        <h3 class="text-success">{{ "%.2f"|format(total_global_paye) }}€</h3>
                    </div>
                    <div class="col-md-3">
                        <h6>Total Général</h6>
                        <h3 class="text-primary">{{ "%.2f"|format(total_global_a_payer + total_global_paye) }}€</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}