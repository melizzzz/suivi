{% extends "base.html" %}

{% block title %}{{ student.prenom }} {{ student.nom }} - Détails{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>{{ student.prenom }} {{ student.nom }}</h2>
        <p class="text-muted mb-0">
            Inscrit le {{ student.date_inscription.strftime('%d/%m/%Y') }}
            {% if current_user.user_type == 'teacher' %}
            - Parent: {{ student.parent.username }} ({{ student.parent.email }})
            {% endif %}
        </p>
    </div>
    {% if current_user.user_type == 'teacher' %}
    <a href="{{ url_for('add_session', student_id=student.id) }}" class="btn btn-success">
        <i class="bi bi-plus"></i> Nouvelle Session
    </a>
    {% endif %}
</div>

<!-- Résumé -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-primary">
            <div class="card-body">
                <h5 class="card-title text-primary">Total Sessions</h5>
                <h3>{{ total_sessions }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h5 class="card-title text-warning">À Payer</h5>
                <h3>{{ "%.2f"|format(total_a_payer) }}€</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <h5 class="card-title text-success">Payé</h5>
                <h3>{{ "%.2f"|format(total_paye) }}€</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <h5 class="card-title text-info">Total</h5>
                <h3>{{ "%.2f"|format(total_a_payer + total_paye) }}€</h3>
            </div>
        </div>
    </div>
</div>

<!-- Liste des sessions -->
<div class="card">
    <div class="card-header">
        <h5>Historique des Sessions</h5>
    </div>
    <div class="card-body">
        {% if sessions %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Matière</th>
                        <th>Durée</th>
                        <th>Prix</th>
                        <th>Statut</th>
                        {% if current_user.user_type == 'teacher' %}
                        <th>Actions</th>
                        {% endif %}
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in sessions %}
                    <tr>
                        <td>
                            {{ session.date_session.strftime('%d/%m/%Y') }}<br>
                            <small class="text-muted">{{ session.date_session.strftime('%H:%M') }}</small>
                        </td>
                        <td>{{ session.matiere }}</td>
                        <td>{{ session.duree }} min</td>
                        <td>{{ "%.2f"|format(session.prix) }}€</td>
                        <td>
                            {% if session.payee %}
                                <span class="badge bg-success">Payé</span>
                            {% else %}
                                <span class="badge bg-warning">À payer</span>
                            {% endif %}
                        </td>
                        {% if current_user.user_type == 'teacher' %}
                        <td>
                            <a href="{{ url_for('mark_paid', session_id=session.id) }}" 
                               class="btn btn-sm {{ 'btn-warning' if session.payee else 'btn-success' }}"
                               onclick="return confirm('Changer le statut de paiement ?')">
                                {{ 'Marquer impayé' if session.payee else 'Marquer payé' }}
                            </a>
                        </td>
                        {% endif %}
                        <td>
                            {% if session.notes %}
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        data-bs-toggle="tooltip" data-bs-placement="top" 
                                        title="{{ session.notes }}">
                                    Voir notes
                                </button>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <p class="text-muted">Aucune session enregistrée pour cet élève.</p>
            {% if current_user.user_type == 'teacher' %}
            <a href="{{ url_for('add_session', student_id=student.id) }}" class="btn btn-primary">
                Ajouter la première session
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<div class="mt-3">
    {% if current_user.user_type == 'teacher' %}
    <a href="{{ url_for('dashboard_teacher') }}" class="btn btn-secondary">Retour au tableau de bord</a>
    {% else %}
    <a href="{{ url_for('dashboard_parent') }}" class="btn btn-secondary">Retour au tableau de bord</a>
    {% endif %}
</div>

<script>
// Initialiser les tooltips Bootstrap
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
})
</script>
{% endblock %}